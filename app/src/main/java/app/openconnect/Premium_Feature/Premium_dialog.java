package app.openconnect.Premium_Feature;import static android.content.Context.MODE_PRIVATE;import android.annotation.SuppressLint;import android.app.Activity;import android.app.Dialog;import android.content.ActivityNotFoundException;import android.content.Context;import android.content.Intent;import android.content.SharedPreferences;import android.net.Uri;import android.os.Bundle;import android.util.Log;import android.view.View;import android.widget.Button;import android.widget.ImageView;import android.widget.LinearLayout;import android.widget.TextView;import android.widget.Toast;import androidx.core.content.ContextCompat;import androidx.viewpager.widget.ViewPager;import com.android.billingclient.api.AcknowledgePurchaseParams;import com.android.billingclient.api.AcknowledgePurchaseResponseListener;import com.android.billingclient.api.BillingClient;import com.android.billingclient.api.BillingClientStateListener;import com.android.billingclient.api.BillingFlowParams;import com.android.billingclient.api.BillingResult;import com.android.billingclient.api.Purchase;import com.android.billingclient.api.SkuDetails;import com.android.billingclient.api.SkuDetailsParams;import app.openconnect.DataManager;import app.openconnect.Disconnect_Module.Disconnect;import com.vpnpro.dubaivpn.R;import org.jetbrains.annotations.NotNull;import java.util.ArrayList;import java.util.List;import java.util.Objects;public class Premium_dialog extends  Dialog implements View.OnClickListener {	LinearLayout mPremiumLowBtn;	LinearLayout mPremiumMiddleBtn;	LinearLayout mPremiumHighBtn;	boolean payment_status;	ImageView mCloseBtn;	TextView  restore;	Button premium_btn, freetrial_subs;	Activity contexts;	TextView third, thirdmonth, twelveemonth, twelveeemonth, fourthmonth, fourth;	String click_box = "";	private static String TAG = Premium.class.getSimpleName().concat(":SUBS");	private BillingClient mBillingClient;	SharedPreferences payment_status_preference;	ImageView toolbar_back_button;	private SkuDetails weeklySub;	private SkuDetails monthlySub;	private SkuDetails yearlySub;	private SkuDetails weeklySubFree;	private SkuDetails monthlySubFree;	private SkuDetails yearlySubFree;	public Premium_dialog(Activity context, int themeResId) {		super(context, themeResId);		contexts = context;	}	@Override	protected void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		setContentView(R.layout.premium);		payment_status_preference = contexts.getSharedPreferences("DATA", MODE_PRIVATE);		mPremiumLowBtn = findViewById(R.id.premium_low);		mPremiumMiddleBtn = findViewById(R.id.premium_mid);		mPremiumHighBtn = findViewById(R.id.premium_high);		mCloseBtn = findViewById(R.id.premium_close_btn);		restore = findViewById(R.id.restore);		premium_btn = findViewById(R.id.premium);		freetrial_subs = findViewById(R.id.freetrial);		third = findViewById(R.id.third);		thirdmonth = findViewById(R.id.thirdmonth);		twelveemonth = findViewById(R.id.twelveemonth);		twelveeemonth = findViewById(R.id.twelveeemonth);		fourthmonth = findViewById(R.id.fourthmonth);		fourth = findViewById(R.id.fourth);		toolbar_back_button = findViewById(R.id.toolbar_back_button);		toolbar_back_button.setOnClickListener(view -> onBackPressed());		restore.setOnClickListener(v -> isUserHasSubscription_premium());		mPremiumLowBtn.setOnClickListener(this);  //per week		mPremiumMiddleBtn.setOnClickListener(this); //per month		mPremiumHighBtn.setOnClickListener(this);  //sale		mCloseBtn.setOnClickListener(this);		premium_btn.setOnClickListener(this);		freetrial_subs.setOnClickListener(this);		// NativeAdNew.showNativeAd(Premium_dialog.this, findViewById(R.id.nativeAddisconnect));		//google billing work..!!		mBillingClient = BillingClient.newBuilder(contexts)				.setListener((billingResult, purchases) -> {					// To be implemented in a later section.					if (billingResult.getResponseCode() ==							BillingClient.BillingResponseCode.OK && purchases != null) {						for (Purchase purchase : purchases) {							handlePurchase(purchase);						}					} else if (billingResult.getResponseCode() ==							BillingClient.BillingResponseCode.USER_CANCELED) {						// Handle an error caused by a user cancelling the purchase flow.					} else {						// Handle any other error codes.					}				})				.enablePendingPurchases()				.build();		mBillingClient.startConnection(new BillingClientStateListener() {			@Override			public void onBillingSetupFinished(@NotNull BillingResult billingResult) {				// once the client has been successfully initialized we will retrieve the products				if (billingResult.getResponseCode() == BillingClient.BillingResponseCode.OK)					getProducts();				set_prices_item();			}			@Override			public void onBillingServiceDisconnected() {				Log.d(TAG, "onBillingServiceDisconnected");			}		});	}	@SuppressLint("SetTextI18n")	private void set_prices_item() {		Log.d(TAG, "getProducts");		final List<String> skuList_set_price = new ArrayList<>();		skuList_set_price.add("buy_basic");		skuList_set_price.add("buy_premium_1month");		skuList_set_price.add("buy_premium_12months");		SkuDetailsParams params_prices = SkuDetailsParams.newBuilder()				.setSkusList(skuList_set_price)				.setType(BillingClient.SkuType.SUBS)				.build();		mBillingClient.querySkuDetailsAsync(params_prices,				(billingResult, skuDetailsList) -> {					if (billingResult.getResponseCode() == BillingClient.BillingResponseCode.OK && skuDetailsList != null) {						if (!skuDetailsList.isEmpty()) {							for (SkuDetails skuDetails : skuDetailsList) {								switch (skuDetails.getSku()) {									case "buy_basic":										weeklySub = skuDetails;										break;									case "buy_premium_1month":										monthlySub = skuDetails;										break;									case "buy_premium_12months":										yearlySub = skuDetails;										break;								}								if (monthlySub != null && yearlySub != null && weeklySub != null) {									Log.d("All_Prices", "  " + monthlySub.getPrice() + "     " + yearlySub.getPrice() + "     " + weeklySub.getPrice());									twelveemonth.setText("" + yearlySub.getPrice());									thirdmonth.setText("" + monthlySub.getPrice());									third.setText("" + weeklySub.getPrice());									twelveeemonth.setText(" " + yearlySub.getPrice() + "/" + "mo");									fourthmonth.setText(" " + monthlySub.getPrice() + "/" + "mo");									fourth.setText(" " + weeklySub.getPrice() + "/" + "wk");								}							}						}					} else {						if (contexts != null) {							Toast.makeText(contexts, "Error in retrieving " + "products from store", Toast.LENGTH_SHORT).show();						}					}				});	}	private void isUserHasSubscription_premium() {		if (mBillingClient == null) {			mBillingClient = BillingClient.newBuilder(contexts)					.enablePendingPurchases()					.build();		}		mBillingClient.startConnection(new BillingClientStateListener() {			@Override			public void onBillingSetupFinished(@NotNull BillingResult billingResult) {				Purchase.PurchasesResult purchasesResult = mBillingClient.queryPurchases(BillingClient.SkuType.SUBS);				mBillingClient.queryPurchaseHistoryAsync(BillingClient.SkuType.SUBS, (billingResult1, list) -> {					if (billingResult1.getResponseCode() == BillingClient.BillingResponseCode.OK &&							!Objects.requireNonNull(purchasesResult.getPurchasesList()).isEmpty()) {						//google tells use that subscription already done..!!						Toast.makeText(contexts, "Already Subscribed", Toast.LENGTH_SHORT).show();					} else {						Toast.makeText(contexts, "No Subscription", Toast.LENGTH_SHORT).show();					}				});			}			@Override			public void onBillingServiceDisconnected() {				// Try to restart the connection on the next request to				// Google Play by calling the startConnection() method.				Log.d("billingprocess", "onBillingServiceDisconnected");			}		});	}	public void viewtermsBrowser(Context context, String url) {		Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));		if (context != null) {			if (intent.resolveActivity(context.getPackageManager()) != null) {				context.startActivity(intent);			}		}	}	private void getProducts() {		Log.d(TAG, "getProducts");		final List<String> skuList = new ArrayList<>();		skuList.add("1week");		skuList.add("one_week_subscription");		skuList.add("1month");		skuList.add("one_month_subscription");		skuList.add("1year");		skuList.add("yearly_month_subscription");		SkuDetailsParams params = SkuDetailsParams.newBuilder()				.setSkusList(skuList)				.setType(BillingClient.SkuType.SUBS)				.build();		mBillingClient.querySkuDetailsAsync(params,				(billingResult, skuDetailsList) -> {					if (billingResult.getResponseCode() == BillingClient.BillingResponseCode.OK							&& skuDetailsList != null) {						if (!skuDetailsList.isEmpty()) {							for (SkuDetails skuDetails : skuDetailsList) {								switch (skuDetails.getSku()) {									case "1week":										weeklySubFree = skuDetails;										break;									case "one_week_subscription":										weeklySub = skuDetails;										break;									case "1month":										monthlySubFree = skuDetails;										break;									case "one_month_subscription":										monthlySub = skuDetails;										break;									case "1year":										yearlySubFree = skuDetails;										break;									case "yearly_month_subscription":										yearlySub = skuDetails;										break;								}							}						}					} else {						if (contexts != null) {							Toast.makeText(contexts, "Error in retrieving " + "products from store", Toast.LENGTH_SHORT).show();						}					}				});	}	private void handlePurchase(Purchase purchase) {		if (purchase.getPurchaseState() == Purchase.PurchaseState.PURCHASED) {			AcknowledgePurchaseResponseListener acknowledgePurchaseResponseListener =					billingResult -> {						// the user's purchase has been successful						if (billingResult.getResponseCode() == BillingClient.BillingResponseCode.OK) {							//TODO set the user's premium status to true							payment_status = true;							SharedPreferences.Editor editor = payment_status_preference.edit();							if (editor != null) {								editor.putBoolean("payment_status", payment_status).apply();							}							DataManager.ADMOB_ENABLE = false;							Log.d("Heree", "aa");							dismiss();						} else {							Log.d("No_Payment_Achieved", "no_subs");							if (payment_status_preference != null) {								SharedPreferences.Editor editor = payment_status_preference.edit();								if (editor != null) {									editor.putBoolean("payment_status", false).apply();									DataManager.ADMOB_ENABLE = true;								}							}						}					};			if (!purchase.isAcknowledged()) {				AcknowledgePurchaseParams acknowledgePurchaseParams =						AcknowledgePurchaseParams.newBuilder()								.setPurchaseToken(purchase.getPurchaseToken())								.build();				mBillingClient.acknowledgePurchase(acknowledgePurchaseParams, acknowledgePurchaseResponseListener);				Log.d("Heree22", "aa");			}		}	}	@Override	public void onClick(View view) {		if (contexts != null) {			switch (view.getId()) {				case R.id.premium_low:					mPremiumLowBtn.setBackground(null);					mPremiumMiddleBtn.setBackground(null);					mPremiumHighBtn.setBackground(null);					mPremiumLowBtn.setBackground(ContextCompat.getDrawable(contexts,							R.drawable.shape_premium_left));					click_box = "premium_low";					break;				case R.id.premium_mid:					mPremiumLowBtn.setBackground(null);					mPremiumMiddleBtn.setBackground(null);					mPremiumHighBtn.setBackground(null);					mPremiumMiddleBtn.setBackground(ContextCompat.getDrawable(contexts, R.drawable.shape_premium_middle));					click_box = "premium_mid";					break;				case R.id.premium_high:					mPremiumLowBtn.setBackground(null);					mPremiumMiddleBtn.setBackground(null);					mPremiumHighBtn.setBackground(null);					mPremiumHighBtn.setBackground(ContextCompat.getDrawable(contexts, R.drawable.shape_premium_right));					click_box = "premium_high";					break;				case R.id.premium:					if (click_box.equals("premium_low")) {						if (weeklySub != null) {							BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder()									.setSkuDetails(weeklySub)									.build();							int responseCode = mBillingClient.launchBillingFlow(contexts, billingFlowParams).getResponseCode();							if (responseCode != BillingClient.BillingResponseCode.OK)								Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();						} else							Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();					} else if (click_box.equals("premium_mid")) {						if (monthlySub != null) {							BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder()									.setSkuDetails(monthlySub)									.build();							int responseCode = mBillingClient.launchBillingFlow(contexts, billingFlowParams).getResponseCode();							if (responseCode != BillingClient.BillingResponseCode.OK)								Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();						} else							Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();					} else if (click_box.equals("premium_high")) {						if (yearlySub != null) {							BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder().setSkuDetails(yearlySub).build();							int responseCode = mBillingClient.launchBillingFlow(contexts, billingFlowParams).getResponseCode();							if (responseCode != BillingClient.BillingResponseCode.OK)								Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();						} else							Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();					} else {						if (yearlySub != null) {							BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder().setSkuDetails(yearlySub).build();							int responseCode = mBillingClient.launchBillingFlow(contexts, billingFlowParams).getResponseCode();							if (responseCode != BillingClient.BillingResponseCode.OK)								Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();						} else							Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();					}					break;//					payment_status = true;//					SharedPreferences.Editor editor = payment_status_preference.edit();//					if (editor != null) {//						editor.putBoolean("payment_status", payment_status).apply();//					}//					Home_Screen.free_or_paid=true;//					Log.d("Heree" , "aa");//					dismiss();//					break;				case R.id.freetrial:					if (click_box.equals("premium_low")) {						if (weeklySubFree != null) {							BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder()									.setSkuDetails(weeklySubFree)									.build();							int responseCode = mBillingClient.launchBillingFlow(contexts, billingFlowParams).getResponseCode();							if (responseCode != BillingClient.BillingResponseCode.OK)								Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();						} else							Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();					} else if (click_box.equals("premium_mid")) {						if (monthlySubFree != null) {							BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder()									.setSkuDetails(monthlySubFree)									.build();							int responseCode = mBillingClient.launchBillingFlow(contexts, billingFlowParams).getResponseCode();							if (responseCode != BillingClient.BillingResponseCode.OK)								Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();						} else							Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();					} else if (click_box.equals("premium_high")) {						if (yearlySubFree != null) {							BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder().setSkuDetails(yearlySubFree).build();							int responseCode = mBillingClient.launchBillingFlow(contexts, billingFlowParams).getResponseCode();							if (responseCode != BillingClient.BillingResponseCode.OK)								Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();						} else							Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();					} else {						if (yearlySubFree != null) {							BillingFlowParams billingFlowParams = BillingFlowParams.newBuilder().setSkuDetails(yearlySubFree).build();							int responseCode = mBillingClient.launchBillingFlow(contexts, billingFlowParams).getResponseCode();							if (responseCode != BillingClient.BillingResponseCode.OK)								Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();						} else							Toast.makeText(contexts, "Error", Toast.LENGTH_SHORT).show();					}					break;				case R.id.premium_close_btn:					dismiss();					break;			}		}	}	@Override	public void onBackPressed() {		super.onBackPressed();	}}